<div>Teachable Machine Audio Model</div>
<button type="button" onclick="init()">Start</button>
<br /><br />
<span id="hablado"></span>
<br /><br />
<div id="label-container"></div>

<script src="/src/ext/tf.min.js"></script>
<script src="/src/ext/speech-commands.min.js"></script>

<script type="text/javascript">
  // more documentation available at
  // https://github.com/tensorflow/tfjs-models/tree/master/speech-commands

  const VOLUME_THRESHOLD = 0.5; // TODO
  const PROB_THRESHOLD = 0.75;
  const OVERLAP_FACTOR = 0.9; // probably want between 0.5 and 0.75, amount of overlap between samples

  // the link to  model provided by Teachable Machine export panel
  const URL = "http://127.0.0.1:8000/models/";
  //"https://teachablemachine.withgoogle.com/models/T-0mi0cUd/"; // 2 voces 100 Epochs

  async function createModel() {
    const checkpointURL = URL + "model.json"; // model topology
    const metadataURL = URL + "metadata.json"; // model metadata

    console.log("Starting engine");

    const recognizer = speechCommands.create(
      "BROWSER_FFT", // fourier transform type, not useful to change
      undefined, // speech commands vocabulary feature, not useful for your models
      checkpointURL,
      metadataURL
    );

    // check that model and metadata are loaded via HTTPS requests.
    await recognizer.ensureModelLoaded();

    return recognizer;
  }

  async function init() {
    const recognizer = await createModel();
    const classLabels = recognizer.wordLabels(); // get class labels
    const labelContainer = document.getElementById("label-container");
    const habladoSpan = document.getElementById("hablado");

    for (let i = 0; i < classLabels.length; i++) {
      labelContainer.appendChild(document.createElement("div"));
    }

    // listen() takes two arguments:
    // 1. A callback function that is invoked anytime a word is recognized.
    // 2. A configuration object with adjustable fields
    recognizer.listen(
      (result) => {
        const scores = result.scores; // probability of prediction for each class
        // render the probability scores per class
        let maxLabel,
          maxProb = 0;

        for (let i = 0; i < classLabels.length; i++) {
          const classPrediction =
            classLabels[i] + ": " + result.scores[i].toFixed(2);
          labelContainer.childNodes[i].innerHTML = classPrediction;
          if (result.scores[i] > maxProb) {
            maxProb = result.scores[i];
            maxLabel = i;
          }
        }
        if (true || maxProb > PROB_THRESHOLD) {
          if (habladoSpan.innerText.length > 30) {
            // imprimimos los ultimos fonemas predichos
            habladoSpan.innerText = habladoSpan.innerText.slice(1, 30);
          }
          habladoSpan.innerText = habladoSpan.innerText + classLabels[maxLabel];
        }
      },
      {
        includeSpectrogram: false, // in case listen should return result.spectrogram
        probabilityThreshold: PROB_THRESHOLD,
        invokeCallbackOnNoiseAndUnknown: false,
        overlapFactor: OVERLAP_FACTOR, // probably want between 0.5 and 0.75. More info in README
      }
    );

    // Stop the recognition in 5 seconds.
    // setTimeout(() => recognizer.stopListening(), 5000);
  }
</script>
